name: Ubuntu GUI (noVNC) + Serveo tunnel

on:
  workflow_dispatch:

jobs:
  gui:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install GUI + VNC + noVNC + SSH tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal dbus-x11 x11-xserver-utils \
            tigervnc-standalone-server tigervnc-common tigervnc-tools \
            novnc websockify openssh-client autossh curl
          command -v vncpasswd || true
          mkdir -p ~/.vnc

      - name: Create VNC password (TigerVNC)
        run: |
          # change this password if you want
          VNC_PASS="12345678"

          if ! command -v vncpasswd >/dev/null 2>&1; then
            echo "ERROR: vncpasswd not found even after install."
            exit 1
          fi

          printf "%s\n%s\n\n" "$VNC_PASS" "$VNC_PASS" | vncpasswd
          chmod 600 ~/.vnc/passwd

      - name: Start XFCE VNC desktop in background
        run: |
          cat > ~/.vnc/xstartup <<'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &
          EOF
          chmod +x ~/.vnc/xstartup

          vncserver -kill :1 >/dev/null 2>&1 || true
          vncserver :1 -geometry 1280x720 -depth 24

          vncserver -list

      - name: Start noVNC on port 6080 in background
        run: |
          nohup websockify --web=/usr/share/novnc/ 6080 localhost:5901 \
            > novnc.log 2>&1 &

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:6080/ >/dev/null; then
              echo "noVNC is up on :6080"
              break
            fi
            sleep 1
          done

      - name: Start Serveo reverse tunnel (keeps job alive)
        run: |
          echo "Opening Serveo tunnel: https://serveo.net -> localhost:6080"
          autossh -M 0 -N \
            -o "ServerAliveInterval=30" \
            -o "ServerAliveCountMax=3" \
            -o "StrictHostKeyChecking=no" \
            -o "UserKnownHostsFile=/dev/null" \
            -R 80:localhost:6080 serveo.net

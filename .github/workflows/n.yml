- name: Install GUI + VNC + noVNC + deps
  run: |
    sudo apt-get update
    sudo apt-get install -y --no-install-recommends \
      xfce4 xfce4-terminal xfce4-session xfwm4 \
      dbus-x11 x11-xserver-utils x11-utils \
      xterm xauth \
      tigervnc-standalone-server tigervnc-common tigervnc-tools \
      novnc websockify openssh-client autossh curl

    mkdir -p ~/.vnc

- name: Create VNC password
  run: |
    VNC_PASS="12345678"
    printf "%s\n%s\n\n" "$VNC_PASS" "$VNC_PASS" | vncpasswd
    chmod 600 ~/.vnc/passwd

- name: Start XFCE VNC desktop (robust xstartup)
  run: |
    cat > ~/.vnc/xstartup <<'EOF'
    #!/bin/sh
    set -e

    unset SESSION_MANAGER
    unset DBUS_SESSION_BUS_ADDRESS

    export XDG_SESSION_TYPE=x11
    export XDG_CURRENT_DESKTOP=XFCE
    export XDG_RUNTIME_DIR="/tmp/xdg-runtime-$USER"
    mkdir -p "$XDG_RUNTIME_DIR"
    chmod 700 "$XDG_RUNTIME_DIR"

    # Start a dbus session if possible
    if command -v dbus-launch >/dev/null 2>&1; then
      eval "$(dbus-launch --sh-syntax)"
    fi

    # Some runners need this
    xsetroot -solid grey || true

    # Start XFCE (fallback to xterm if it fails)
    (startxfce4 >/tmp/vnc-xfce.log 2>&1) || (xterm >/tmp/vnc-xterm.log 2>&1)
    EOF

    chmod +x ~/.vnc/xstartup

    vncserver -kill :1 >/dev/null 2>&1 || true

    # Clean stale files
    rm -f ~/.vnc/*.pid ~/.vnc/*.log || true

    # Start VNC
    vncserver :1 -geometry 1280x720 -depth 24

    echo "==== VNC LOG ===="
    ls -la ~/.vnc || true
    tail -n +1 ~/.vnc/*.log || true
s
